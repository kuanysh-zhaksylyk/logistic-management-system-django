# Документация проекта Django: Система управления перевозками

## Структура проекта:

src/
├── apps/
│   └── logistic/
│       ├── __pycache__/
│       ├── migrations/
│       ├── __init__.py
│       ├── admin.py
│       ├── apps.py
│       ├── models.py
│       ├── paginator.py
│       ├── serializers.py
│       ├── urls.py
│       └── views.py
├── base/
│   ├── __pycache__/
│   ├── __init__.py
│   ├── settings.py
│   └── urls.py
├── deploy/
│   ├── __pycache__/
│   ├── __init__.py
│   ├── asgi.py
│   └── wsgi.py
├── db.sqlite3
├── manage.py
├── .gitignore
└── INITIAL.md
README.md
requirements.txt

## 1. Описание базы данных и структуры таблиц

Система управления перевозками включает следующие основные сущности:

### 1.1. Клиенты (Clients)
Хранят информацию о клиентах, заказывающих перевозку.

| Поле         | Тип данных | Описание                                 | Primary Key | Foreign Key |
|--------------|------------|------------------------------------------|-------------|-------------|
| `ID`         | Integer    | Уникальный идентификатор клиента         | Yes         |             |
| `first_name` | String     | Имя клиента                              | No          |             |
| `last_name`  | String     | Фамилия клиента                          | No          |             |
| `email`      | Email      | Электронная почта                        | No          |             |
| `phone`      | String     | Номер телефона                           | No          |             |
| `created_at` | DateTime   | Временная метка создания записи          | No          |             |
| `updated_at` | DateTime   | Временная метка обновления записи        | No          |             |

### 1.2. Локации (Location)
Определяют географические точки для маршрутов.

| Поле          | Тип данных | Описание                                 | Primary Key | Foreign Key |
|---------------|------------|------------------------------------------|-------------|-------------|
| `ID`          | Integer    | Уникальный идентификатор локации         | Yes         |             |
| `location_name` | String     | Название локации (например, "Алматы")     | No          |             |
| `created_at`  | DateTime   | Временная метка создания записи          | No          |             |
| `updated_at`  | DateTime   | Временная метка обновления записи        | No          |             |

### 1.3. Маршруты (Routes)
Определяют маршруты перевозок.

| Поле              | Тип данных | Описание                             | Primary Key | Foreign Key          |
|-------------------|------------|--------------------------------------|-------------|----------------------|
| `ID`              | Integer    | Уникальный идентификатор маршрута    | Yes         |                      |
| `origin_code`     | ForeignKey | Пункт отправления (Location.ID)      | No          | `Location(ID)`       |
| `destination_code`| ForeignKey | Пункт назначения (Location.ID)       | No          | `Location(ID)`       |
| `distance`        | Integer    | Расстояние в км                      | No          |                      |
| `created_at`      | DateTime   | Временная метка создания записи      | No          |                      |
| `updated_at`      | DateTime   | Временная метка обновления записи    | No          |                      |

### 1.4. Заказы (Orders)
Описывают основные заказы на перевозку.

| Поле         | Тип данных | Описание                                 | Primary Key | Foreign Key      |
|--------------|------------|------------------------------------------|-------------|------------------|
| `ID`         | Integer    | Уникальный идентификатор заказа          | Yes         |                  |
| `client_id`  | ForeignKey | Клиент, оформивший заказ (Clients.ID)    | No          | `Clients(ID)`    |
| `route_id`   | ForeignKey | Маршрут перевозки (Routes.ID)           | No          | `Routes(ID)`     |
| `status`     | String     | Статус заказа (pending, in_progress, completed, canceled) | No          |                  |
| `created_at` | DateTime   | Временная метка создания записи          | No          |                  |
| `updated_at` | DateTime   | Временная метка обновления записи        | No          |                  |

### 1.5. Позиции заказов (Orders_Items)
Позволяют разбивать заказы на партии.

| Поле         | Тип данных | Описание                                 | Primary Key | Foreign Key     |
|--------------|------------|------------------------------------------|-------------|-----------------|
| `ID`         | Integer    | Уникальный идентификатор позиции заказа  | Yes         |                 |
| `order_id`   | ForeignKey | Связанный заказ (Orders.ID)             | No          | `Orders(ID)`    |
| `created_at` | DateTime   | Временная метка создания записи          | No          |                 |
| `updated_at` | DateTime   | Временная метка обновления записи        | No          |                 |

### 1.6. Машины (Cars)
Хранят информацию о доступных автомобилях.

| Поле                | Тип данных | Описание                                     | Primary Key | Foreign Key         | Unique |
|---------------------|------------|----------------------------------------------|-------------|---------------------|--------|
| `ID`                | Integer    | Уникальный идентификатор машины              | Yes         |                     |        |
| `model`             | String     | Модель автомобиля                            | No          |                     |        |
| `number`            | String     | Регистрационный номер машины                 | No          |                     | Yes    |
| `capacity`          | Integer    | Грузоподъемность                             | No          |                     |        |
| `current_location_id`| ForeignKey | Текущая локация машины (Location.ID)        | No          | `Location(ID)`      |        |
| `created_at`        | DateTime   | Временная метка создания записи              | No          |                     |        |
| `updated_at`        | DateTime   | Временная метка обновления записи            | No          |                     |        |

### 1.7. Водители (Drivers)
Хранят информацию о водителях.

| Поле                | Тип данных | Описание                                     | Primary Key | Foreign Key         | Unique |
|---------------------|------------|----------------------------------------------|-------------|---------------------|--------|
| `ID`                | Integer    | Уникальный идентификатор водителя            | Yes         |                     |        |
| `first_name`        | String     | Имя водителя                                 | No          |                     |        |
| `last_name`         | String     | Фамилия водителя                             | No          |                     |        |
| `phone_number`      | String     | Номер телефона водителя                      | No          |                     |        |
| `licence_number`    | String     | Номер водительского удостоверения            | No          |                     | Yes    |
| `licence_category`  | String     | Категория прав                               | No          |                     |        |
| `current_location_id`| ForeignKey | Текущая локация водителя (Location.ID)       | No          | `Location(ID)`      |        |
| `created_at`        | DateTime   | Временная метка создания записи              | No          |                     |        |
| `updated_at`        | DateTime   | Временная метка обновления записи            | No          |                     |        |

### 1.8. Перевозки (Shipments)
Связывают заказы с машинами и водителями.

| Поле         | Тип данных | Описание                                     | Primary Key | Foreign Key      |
|--------------|------------|----------------------------------------------|-------------|------------------|
| `ID`         | Integer    | Уникальный идентификатор перевозки           | Yes         |                  |
| `driver_id`  | ForeignKey | Водитель, выполняющий перевозку (Drivers.ID) | No          | `Drivers(ID)`    |
| `order_id`   | ForeignKey | Заказ, связанный с перевозкой (Orders.ID)    | No          | `Orders(ID)`     |
| `car_id`     | ForeignKey | Машина, выполняющая перевозку (Cars.ID)      | No          | `Cars(ID)`       |
| `status`     | String     | Статус перевозки (pending, in_transit, delivered, failed) | No          |                  |
| `created_at` | DateTime   | Временная метка создания записи              | No          |                  |
| `updated_at` | DateTime   | Временная метка обновления записи            | No          |                  |

**Ограничение:** Один водитель и одна машина не могут участвовать в двух активных перевозках одновременно (контроль через ORM).

### 1.9. Позиции перевозок (Shipment_Items)
Связывают партии заказов с перевозками.

| Поле          | Тип данных | Описание                                     | Primary Key | Foreign Key         |
|---------------|------------|----------------------------------------------|-------------|---------------------|
| `ID`          | Integer    | Уникальный идентификатор позиции перевозки   | Yes         |                     |
| `order_item_id`| ForeignKey | Ссылка на позицию заказа (Orders_Items.ID)  | No          | `Orders_Items(ID)`  |
| `shipment_id` | ForeignKey | Ссылка на перевозку (Shipments.ID)         | No          | `Shipments(ID)`     |
| `status`      | String     | Статус (pending, loaded, in_transit, delivered, failed) | No          |                     |
| `created_at`  | DateTime   | Временная метка создания записи              | No          |                     |
| `updated_at`  | DateTime   | Временная метка обновления записи            | No          |                     |

### 1.10. Архив перевозок (Shipments_Archive)
Хранит завершенные перевозки.

| Поле         | Тип данных | Описание                                 | Primary Key |
|--------------|------------|------------------------------------------|-------------|
| `ID`         | Integer    | Уникальный идентификатор                 | Yes         |
| `original_id`| Integer    | ID исходной записи из Shipments          | No          |
| `driver_id`  | Integer    | ID водителя                               | No          |
| `car_id`     | Integer    | ID машины                                 | No          |
| `status`     | String     | Статус перевозки                         | No          |
| `created_at` | DateTime   | Время создания оригинальной записи       | No          |
| `updated_at` | DateTime   | Время обновления оригинальной записи     | No          |
| `archived_at`| DateTime   | Время архивирования                      | No          |

**Ограничение:** При завершении перевозки запись переносится в архив и удаляется из Shipments.

## 2. Бизнес-логика системы

### 2.1. Запрет на дублирование активных перевозок
🚫 Водитель не может взять новый заказ, пока не завершит текущий.
🚫 Машина не может участвовать в другой перевозке, пока не завершена текущая.
✅ Это реализуется на уровне ORM с проверкой перед созданием новой записи в `Shipments`.

### 2.2. Ограничение по текущей локации
🚛 Перевозку могут взять только те водители и машины, которые находятся в `origin_code` маршрута.
✅ Проверяется перед созданием новой `Shipments`.

### 2.3. Архивирование завершенных перевозок
✅ При `status = 'delivered'` в таблице `Shipments`, перевозка переносится в `Shipments_Archive`.
✅ В `Shipments_Archive` сохраняются все данные оригинальной записи из `Shipments`.
✅ Запись удаляется из `Shipments`, освобождая машину и водителя.

### 2.4. Разделение заказов на партии
✅ `Orders_Items` позволяет делить заказ на партии.
✅ `Shipment_Items` позволяет отправлять партии разными машинами/водителями.

### 2.5. Логика обработки маршрутов
✅ Каждой `Shipments` соответствует `route_id` из `Orders`.
✅ Машина и водитель должны находиться в `origin_code` маршрута, иначе они не могут взять перевозку.
✅ После завершения перевозки `current_location_id` у соответствующей машины и водителя обновляется на `destination_code` из `Routes`.

## 3. Итог

📌 Водители и машины теперь могут работать только в своей текущей локации.
📌 Перевозки нельзя дублировать, если водитель или машина уже заняты.
📌 Завершенные перевозки архивируются.
📌 Заказы могут делиться на партии и отправляться разными машинами.

## Улучшения:

* **Учет груза:** Добавить возможность учета характеристик груза (объём, вес и пр.) для принятия решения о разделении заказа.
* **Автоматическая синхронизация партий:** При добавлении партии в уже созданный заказ, она должна автоматически отображаться в `Shipment_Items` для активной перевозки.
* **Обновление статуса перевозки:** Добавить возможность пользователю обновлять статус перевозки (`Shipments.status` и `Shipment_Items.status`) в процессе выполнения.

---

# Техническое задание

## Система управления перевозками

**Цель проекта:**

Создать информационную систему, которая позволит управлять грузовыми перевозками: обрабатывать заказы клиентов, планировать маршруты, назначать водителей и автомобили, отслеживать статусы перевозок, а также вести архив завершённых операций.

### 🔹 Основные функции системы:

**Работа с клиентами:**

Система должна хранить информацию о клиентах, которые оформляют заказы на перевозку. Для каждого клиента указывается имя, контактные данные и история заказов. (Реализовано через модель `Clients`).

**Маршруты и локации:**

Поддерживаются различные географические точки (например, города), которые используются как пункты отправления и назначения в маршрутах перевозок. Каждый маршрут включает в себя расстояние между пунктами. (Реализовано через модели `Location` и `Routes`).

**Оформление заказов:**

Клиенты могут оформлять заказы на перевозку груза. Один заказ может быть разбит на несколько частей (партий), которые могут доставляться разными машинами и водителями. (Реализовано через модели `Orders` и `Orders_Items`).

**Назначение перевозки:**

К каждому заказу можно привязать перевозку, которая будет выполняться конкретным водителем на конкретной машине. Перед началом перевозки система проверяет:

* свободны ли водитель и машина (контроль через ORM при создании `Shipments`);
* находятся ли они в нужном городе (начальной точке маршрута) (проверка `current_location_id` водителя/машины и `origin_code` маршрута при создании `Shipments`).

Только при выполнении этих условий перевозка может быть начата. (Бизнес-логика реализована при создании записей в `Shipments`).

**Контроль занятости:**

Водитель и машина могут участвовать только в одной активной перевозке одновременно. Пока перевозка не завершена, они считаются занятыми. (Реализовано через ограничения на уровне ORM при создании новых записей в `Shipments`).

**Завершение перевозки и архив:**

После завершения перевозки (доставки груза) система автоматически переносит данные в архив (`Shipments_Archive`) и освобождает водителя и машину для новых задач (удаление записи из `Shipments`). (Бизнес-логика реализована при обновлении статуса `Shipments` на 'delivered').

**Отслеживание партий:**

Если заказ состоит из нескольких партий, каждая партия может доставляться отдельно. Система отслеживает статусы каждой партии в рамках своей перевозки. (Реализовано через модели `Shipment_Items` и их связь с `Orders_Items`).

**Статусы перевозки:**

Для перевозок (`Shipments`) и партий (`Shipment_Items`) предусматриваются различные статусы, такие как:

* ожидание (`pending`);
* в пути (`in_transit`, `loaded`);
* доставлено (`delivered`);
* неудача (ошибка или сбой) (`failed`).

Пользователь должен иметь возможность обновлять статус в процессе выполнения перевозки. (Требуется реализация API для обновления полей `status` в моделях `Shipments` и `Shipment_Items`).

### 🔹 Возможности для развития:

**Учет груза:**

Добавить возможность указывать характеристики груза (объём, вес и пр.), чтобы система могла автоматически предлагать разделение на партии при превышении вместимости транспорта. (Требуется добавление полей в модель `Orders_Items` и соответствующая логика).

**Автоматическая синхронизация партий:**

Если в заказ добавлена новая партия (`Orders_Items`), она автоматически должна отображаться в перевозке (`Shipment_Items`), если перевозка ещё активна. (Требуется реализация сигналов Django или логики в API при создании `Orders_Items`).

**Гибкое управление статусами:**

Автоматическое обновление статусов перевозок (например, на основе геолокации водителя - требует интеграции с внешними сервисами).

### 💡 Результат:

Упорядоченная система, где каждый заказ отслеживается, разбивается на части, назначается на свободных и доступных водителей и машины.

Водители и машины работают только в пределах текущей локации.

Завершённые перевозки сохраняются в архив.

Возможность масштабирования за счёт учёта характеристик груза и автоматизации рутинных процессов.
